name: SCA

on:
  schedule:
    - cron: "15 7 * * 1"

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  trivy-fs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Trivy FS scan (repo & lockfile)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: fs
          skip-dirs: node_modules,dist,coverage,reports,allure-results,allure-report
          format: sarif
          output: trivy-fs.sarif
          ignore-unfixed: true
          severity: CRITICAL,HIGH,MEDIUM

      - name: Upload SARIF (Trivy FS)
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-fs.sarif

  trivy-images:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image:
          - selenium/hub:4.35.0-20250808
          - selenium/node-chromium:139.0.7258.66-chromedriver-139.0.7258.66-grid-4.35.0-20250808
          - selenium/node-firefox:141.0.3-geckodriver-0.36.0-grid-4.35.0-20250808
          - selenium/node-edge:4.35.0-20250808
    steps:
      - name: Pull ${{ matrix.image }}
        run: docker pull ${{ matrix.image }}

      # Derive a filesystem-safe filename from the image reference
      - name: Compute SARIF filename
        id: fname
        shell: bash
        run: |
          img="${{ matrix.image }}"
          base="${img##*/}"          # after last '/'
          safe="${base//[:@]/_}"     # replace ':' and '@' with '_'
          echo "safe=$safe" >> "$GITHUB_OUTPUT"

      - name: Trivy image scan ${{ matrix.image }}
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ matrix.image }}
          format: sarif
          output: "trivy-${{ steps.fname.outputs.safe }}.sarif"
          ignore-unfixed: true
          severity: CRITICAL,HIGH,MEDIUM

      - name: Upload SARIF (Trivy image)
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-${{ steps.fname.outputs.safe }}.sarif"
